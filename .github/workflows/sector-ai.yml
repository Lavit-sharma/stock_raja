name: AI Stock Sectors

on:
  workflow_dispatch:
    inputs:
      start_index:
        description: 'Start index'
        required: false
        default: '0'
        type: string
      end_index:
        description: 'End index'
        required: false
        default: '2500'
        type: string
      max_workers:
        description: 'Workers'
        required: false
        default: '10'
        type: string
  schedule:
    - cron: '0 3 * * 1'

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Force upgrade to versions that fix the 'proxies' error
          pip install --upgrade "openai>=1.55.3" "httpx>=0.28.0" gspread
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
      - name: Create credentials
        env:
          GSPREAD_CREDENTIALS: ${{ secrets.GSPREAD_CREDENTIALS }}
        run: |
          echo "$GSPREAD_CREDENTIALS" > credentials.json
          echo "âœ… Credentials ready"
      
      - name: Run AI Sector Scraper
        env:
          START_INDEX: ${{ github.event.inputs.start_index || '0' }}
          END_INDEX: ${{ github.event.inputs.end_index || '2500' }}
          MAX_WORKERS: ${{ github.event.inputs.max_workers || '10' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GSPREAD_CREDENTIALS: ${{ secrets.GSPREAD_CREDENTIALS }}
        run: python sector_ai.py
        
      - name: Upload checkpoint
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkpoint
          path: checkpoint.txt
